<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Archivio Ricette / Recipes Archive</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; }
      header { padding: 16px 20px; border-bottom: 1px solid #ddd; }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        padding: 16px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        background: #fff;
        display: block;
      }
      .thumb {
        width: 100%;
        aspect-ratio: 4 / 3;
        object-fit: cover;
        display: block;
        background: #f3f3f3;
      }
      .meta { padding: 12px; }
      .title { font-weight: 650; margin: 0 0 6px; }
      .subtitle { margin: 0; opacity: 0.75; font-size: 14px; }
      .status { padding: 16px; opacity: .75; }
      .error { padding: 16px; color: #b00; }
    </style>
  </head>

  <body>
    <header>
      <h1 style="margin:0; font-size:18px;">Archivio Ricette / Recipes Archive</h1>
      <p style="margin:6px 0 0; opacity:.75;">
        Gallery is generated from <code>recipes.json</code>.
      </p>
    </header>

    <div id="status" class="status">Loading recipes…</div>
    <main class="grid" id="grid"></main>

    <script>
      // Where a clicked card should go:
      // This assumes your recipe viewer can accept ?id=recipe-001
      // (If instead you prefer ?manifest=..., tell me and I’ll switch it.)
      const RECIPE_PAGE = "./recipe.html";
      const DEFAULT_LANG = "it";

      function pickLang(iiifLangMap, lang = DEFAULT_LANG) {
        if (!iiifLangMap) return "";
        if (typeof iiifLangMap === "string") return iiifLangMap;

        // IIIF language maps are usually { "it": ["..."], "en": ["..."] }
        const v = iiifLangMap[lang] || iiifLangMap.en || iiifLangMap.it;
        if (Array.isArray(v)) return v[0] || "";
        return v || "";
      }

      function summaryToText(summary) {
        if (!summary) return "";
        if (typeof summary === "string") return summary;
        // IIIF summary is a language map: { it: ["..."], en: ["..."] }
        const v = summary[DEFAULT_LANG] || summary.en || summary.it;
        if (Array.isArray(v)) return v[0] || "";
        return v || "";
      }

      function addCard(recipe) {
        const grid = document.getElementById("grid");

        const title =
          recipe.title_it ||
          pickLang(recipe.label, "it") ||
          recipe.title_en ||
          pickLang(recipe.label, "en") ||
          recipe.id;

        const subtitle =
          summaryToText(recipe.summary) ||
          pickLang(recipe.summary, DEFAULT_LANG) ||
          "";

        const a = document.createElement("a");
        a.className = "card";
        a.href = `${RECIPE_PAGE}?id=${encodeURIComponent(recipe.id)}`;

        const img = document.createElement("img");
        img.className = "thumb";
        img.loading = "lazy";
        img.src = recipe.thumbnail || "";
        img.alt = title;

        const meta = document.createElement("div");
        meta.className = "meta";

        const t = document.createElement("p");
        t.className = "title";
        t.textContent = title;

        const s = document.createElement("p");
        s.className = "subtitle";
        s.textContent = subtitle;

        meta.appendChild(t);
        meta.appendChild(s);

        a.appendChild(img);
        a.appendChild(meta);
        grid.appendChild(a);
      }

      async function main() {
        const status = document.getElementById("status");
        status.textContent = "Loading recipes…";

        const res = await fetch("./recipes.json", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("Could not load recipes.json (did you commit it to the repo root?).");
        }

        const recipes = await res.json();
        if (!Array.isArray(recipes) || recipes.length === 0) {
          status.textContent = "No recipes found in recipes.json.";
          return;
        }

        // Optional: sort by id (recipe-001, recipe-002, ...)
        recipes.sort((a, b) => (a.id || "").localeCompare(b.id || "", undefined, { numeric: true }));

        recipes.forEach(addCard);
        status.textContent = "";
      }

      main().catch(err => {
        const status = document.getElementById("status");
        status.className = "error";
        status.textContent = err.message;
      });
    </script>
  </body>
</html>
